# LogiX 架构说明：数据流和外部API连接

## 核心问题：logistics-path-system 是连接外部API的服务吗？

**答案：不是！**

---

## 正确的架构理解

### 1. 物流路径微服务的职责

```
┌─────────────────────────────────────────────────────────┐
│        logistics-path-system (端口 4000)               │
│                                                         │
│  ❌ 不直接连接外部API                                  │
│  ✅ 接收标准化的物流状态数据                            │
│  ✅ 状态机验证（33种状态，100+规则）                    │
│  ✅ 生成物流可视化路径                                 │
│  ✅ 提供GraphQL API查询接口                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │        GraphQL API                              │   │
│  │  • getStatusPathByContainer()                   │   │
│  │  • validateStatusPath()                         │   │
│  │  • syncExternalData() ← 接收外部数据             │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  当前数据来源:                                          │
│  ┌─────────────────┐                                   │
│  │  模拟数据 (Mock)│ ← 临时，用于测试                  │
│  └─────────────────┘                                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2. 主服务的外部API连接

```
┌─────────────────────────────────────────────────────────┐
│         backend 主服务 (端口 3001)                      │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │         外部数据适配器层 ⭐⭐⭐                   │   │
│  │                                                  │   │
│  │  ┌────────────────────────────────────────┐     │   │
│  │  │         Adapter Manager               │     │   │
│  │  │  • 统一管理所有外部API                 │     │   │
│  │  │  • 自动切换、健康检查                   │     │   │
│  │  └────────────────────────────────────────┘     │   │
│  │           ↓                    ↓              │   │
│  │  ┌──────────────┐    ┌──────────────┐           │   │
│  │  │  FeiTuo      │    │  Future...   │           │   │
│  │  │  Adapter     │    │  Adapter     │           │   │
│  │  │              │    │              │           │   │
│  │  │  ⚠️ 直接连接  │    │  (待实现)     │           │   │
│  │  │     飞驼API   │    │              │           │   │
│  │  └──────────────┘    └──────────────┘           │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 完整的数据流架构

### 场景：从飞驼获取物流数据并展示

```
┌────────────────────────────────────────────────────────────────────┐
│                        客户端 (Frontend)                            │
│  Vue 3 / Mobile App / 管理后台                                       │
└────────────────────────────────┬───────────────────────────────────┘
                                 │ HTTP Request
                                 ↓
┌────────────────────────────────┴───────────────────────────────────┐
│                    LogiX 主服务 (3001)                             │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  外部数据适配器层 ⭐                          │  │
│  │                                                              │  │
│  │  AdapterManager.getContainerStatusEvents(containerNumber)     │  │
│  │                ↓                                               │  │
│  │  ┌────────────────────────────────────────────────────┐     │  │
│  │  │ FeiTuoAdapter                                      │     │  │
│  │  │   ↓                                                │     │  │
│  │  │  axios.post('https://api.feituo.com/v1/...')      │     │  │
│  │  │   ↓                                                │     │  │
│  │  │  飞驼API返回原始数据                                │     │  │
│  │  │   ↓                                                │     │  │
│  │  │  转换为标准格式 → ContainerStatusNode[]            │     │  │
│  │  └────────────────────────────────────────────────────┘     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                          ↓                                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              数据持久化层 (TypeORM)                           │  │
│  │                                                              │  │
│  │  保存到PostgreSQL:                                           │  │
│  │  • container_status_events      → 状态节点                  │  │
│  │  • container_loading_records    → 装载记录                  │  │
│  │  • container_hold_records       → HOLD记录                 │  │
│  │  • container_charges            → 费用记录                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                          ↓                                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              物流路径服务层                                    │  │
│  │                                                              │  │
│  │  logisticsPathService.syncToMicroservice(data)               │  │
│  │                ↓                                               │  │
│  │  发送到物流路径微服务...                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────────┬───────────────────────────────────┘
                                 │ GraphQL Mutation
│          POST http://localhost:4000/graphql
│          { syncExternalData(source: "feituo", data: {...}) }
↓
┌────────────────────────────────┴───────────────────────────────────┐
│           物流路径微服务 (logistics-path-system, 4000)              │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  GraphQL 接收层                                │  │
│  │                                                              │  │
│  │  syncExternalData(source, data, containerNumber)             │  │
│  │                ↓                                               │  │
│  │  接收标准化的状态事件数据                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                          ↓                                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  状态机验证层                                │  │
│  │                                                              │  │
│  │  pathValidator.validateStatusPath(path)                    │  │
│  │                ↓                                               │  │
│  │  验证:                                                        │  │
│  │  • 状态流转合法性 (100+ 规则)                                │  │
│  │  • 时间顺序正确性                                             │  │
│  │  • 重复状态检测                                               │  │
│  │  • 异常状态识别                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                          ↓                                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  路径生成层                                    │  │
│  │                                                              │  │
│  │  processStatusPath(nodes, containerNumber)                   │  │
│  │                ↓                                               │  │
│  │  生成:                                                        │  │
│  │  • StatusPath (完整物流路径)                                 │  │
│  │  • StatusNode[] (状态节点列表)                               │  │
│  │  • overallStatus (整体状态: ON_TIME/DELAYED/HOLD)           │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                          ↓                                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  存储层 (模拟/未来数据库)                     │  │
│  │                                                              │  │
│  │  保存 StatusPath 到内存/数据库                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────────┬───────────────────────────────────┘
                                 │ GraphQL Query Response
                                 ↓
┌────────────────────────────────┴───────────────────────────────────┐
│                    LogiX 主服务 (3001)                             │
│                                                                    │
│  logisticsPathService.getStatusPathByContainer(containerNumber)    │
│                          ↓                                         │
│  返回给客户端: StatusPath                                          │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
                                 ↓
┌────────────────────────────────┴───────────────────────────────────┐
│                        客户端 (Frontend)                            │
│  渲染物流时间轴可视化组件                                           │
└────────────────────────────────────────────────────────────────────┘
```

---

## 关键职责划分

### 主服务

| 职责 | 说明 | 文件位置 |
|------|------|---------|
| ✅ 连接外部API | FeiTuoAdapter 直接调用飞驼API | `src/adapters/FeiTuoAdapter.ts` |
| ✅ 数据适配 | 将外部API数据转换为标准格式 | `src/adapters/*.ts` |
| ✅ 数据持久化 | 保存到PostgreSQL数据库 | `src/entities/*.ts` |
| ✅ API网关 | 为前端提供统一RESTful API | `src/controllers/*.ts` |
| ✅ WebSocket | 实时推送物流更新 | `src/server.ts` |

### 物流路径微服务

| 职责 | 说明 | 文件位置 |
|------|------|---------|
| ❌ 连接外部API | 不直接连接，只接收数据 | - |
| ✅ 状态机验证 | 验证状态流转合法性 (100+规则) | `src/utils/pathValidator.ts` |
| ✅ 路径生成 | 生成物流可视化路径 | `src/resolvers/logistics.resolvers.ts` |
| ✅ GraphQL API | 提供GraphQL查询接口 | `src/graphql/logistics.schema.ts` |
| ✅ 数据接收 | 接收主服务发送的标准数据 | `src/resolvers/logistics.resolvers.ts` |

---

## 数据来源对比

### 当前架构

```
主服务 ──HTTP──→ 飞驼API (外部)
  │
  └─→ PostgreSQL (数据库)
      │
      └─→ 物流路径微服务 (只接收，不直接连接外部API)
```

### 未来扩展（其他外部API）

```
主服务
  ├── FeiTuoAdapter ──→ 飞驼API ✅ 已实现
  ├── MSCAdapter ──→ 马士基API ⭐ 待实现
  ├── MaerskAdapter ──→ 马士基API ⭐ 待实现
  ├── COSCOAdapter ──→ 中远海运API ⭐ 待实现
  └── CustomApiAdapter ──→ 自定义API ⭐ 待实现
  │
  └─→ PostgreSQL
      │
      └─→ 物流路径微服务 (统一处理所有来源的数据)
```

---

## 总结

### logistics-path-system 不直接连接外部API

```
错误理解:
  logistics-path-system ──→ 飞驼API  ❌

正确理解:
  主服务 ──→ 飞驼API ✅
    ↓
  主服务 ──→ PostgreSQL ✅
    ↓
  主服务 ──→ logistics-path-system ✅
```

### 为什么这样设计？

1. **职责分离**
   - 主服务负责：数据获取、存储、API网关
   - 微服务负责：数据处理、状态验证、可视化生成

2. **易于扩展**
   - 添加新的外部API：只需在主服务添加新的Adapter
   - 不需要修改微服务代码

3. **性能优化**
   - 微服务专注于计算密集的状态机验证
   - 主服务处理I/O密集的外部API调用

4. **可维护性**
   - 每个服务职责单一，易于测试和维护
   - 可以独立部署和扩展

---

## 下一步开发建议

### 短期

1. **完善 FeiTuoAdapter**
   - 实现真实的飞驼API调用
   - 添加数据缓存机制
   - 完善错误处理和重试逻辑

2. **实现数据同步**
   - 主服务 → 物流路径微服务的数据同步
   - 定时任务同步历史数据
   - Webhook接收实时数据

### 中期

1. **添加更多适配器**
   - MSC Adapter
   - Maersk Adapter
   - COSCO Adapter

2. **完善微服务**
   - 替换模拟数据为真实数据库
   - 添加缓存层
   - 实现实时订阅（WebSocket）

### 长期

1. **智能数据源选择**
   - 根据集装箱号自动选择最佳API
   - 数据源健康度评估
   - 成本优化（选择最便宜的API）

---

**最后更新**: 2026-02-24
**文档版本**: 1.0.0
