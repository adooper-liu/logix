# 数据库初始化完整指南

**文档版本**: v1.0
**最后更新**: 2026-02-24
**适用环境**: PostgreSQL 14+

---

## 📋 概述

本文档提供 LogiX 系统数据库初始化的完整步骤，包括表结构创建、初始数据加载和迁移执行。

---

## 🎯 初始化步骤总览

```
1. 创建数据库
   ↓
2. 运行表结构脚本
   ↓
3. 运行初始数据脚本
   ↓
4. 验证数据完整性
   ↓
5. 启动应用
```

---

## 📦 前置要求

### 环境要求

- **PostgreSQL**: 14.0 或更高版本
- **Node.js**: 18.0 或更高版本
- **npm**: 9.0 或更高版本

### 配置文件

确保 `.env` 文件配置正确:

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=your_password
DB_DATABASE=logix_db

# TypeORM 配置
DB_SYNCHRONIZE=false  # 生产环境必须为 false
DB_LOGGING=false     # 生产环境必须为 false

# 应用配置
NODE_ENV=production
PORT=3001
```

---

## 🚀 初始化步骤

### 步骤1: 创建数据库

**方式1: 使用 psql 命令行**

```bash
# 连接到 PostgreSQL
psql -U postgres

# 创建数据库
CREATE DATABASE logix_db;
CREATE USER logix_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE logix_db TO logix_user;
\q
```

**方式2: 使用 SQL 文件**

```sql
-- scripts/create-database.sql
CREATE DATABASE logix_db
    WITH
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_US.UTF-8'
    LC_CTYPE = 'en_US.UTF-8'
    TEMPLATE = template0;

\c logix_db

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

执行脚本:
```bash
psql -U postgres -f scripts/create-database.sql
```

---

### 步骤2: 运行表结构脚本

**执行完整表结构脚本:**

```bash
psql -U postgres -d logix_db -f scripts/init-database-complete.sql
```

**预期输出:**
```
NOTICE:  relation "dict_ports" already exists, skipping
NOTICE:  relation "dict_shipping_companies" already exists, skipping
...
 message
--------------------------------------------------------------------
 Database initialization completed successfully!
(1 row)
```

**验证表创建:**

```sql
-- 检查所有表
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

预期结果:
```
biz_containers
biz_replenishment_orders
container_charges
container_hold_records
container_loading_records
container_status_events
dict_container_types
dict_customs_brokers
dict_freight_forwarders
dict_ports
dict_shipping_companies
dict_trucking_companies
dict_warehouses
ext_demurrage_records
ext_demurrage_standards
process_empty_returns
process_port_operations
process_sea_freight
process_trucking
process_warehouse_operations
sys_audit_logs
sys_configs
sys_notifications
sys_roles
sys_user_roles
sys_users
```

---

### 步骤3: 运行初始数据脚本

```bash
psql -U postgres -d logix_db -f scripts/init-database.sql
```

**预期输出:**
```
INSERT 0 7   -- 港口数据
INSERT 0 4   -- 船公司数据
INSERT 0 5   -- 柜型数据
...
 status
--------------------------
 Database initialization completed successfully!
(1 row)
```

---

### 步骤4: 验证数据完整性

**验证字典数据:**

```sql
-- 港口字典
SELECT COUNT(*) as port_count FROM dict_ports;
-- 预期: 7

-- 船公司字典
SELECT COUNT(*) as company_count FROM dict_shipping_companies;
-- 预期: 4

-- 柜型字典
SELECT COUNT(*) as type_count FROM dict_container_types;
-- 预期: 5
```

**验证示例业务数据:**

```sql
-- 备货单
SELECT COUNT(*) as order_count FROM biz_replenishment_orders;
-- 预期: 2

-- 货柜
SELECT COUNT(*) as container_count FROM biz_containers;
-- 预期: 3
```

**验证表结构:**

```sql
-- 检查 container_loading_records 表结构
\d container_loading_records
```

预期包含以下字段:
- id, container_number, route_path
- vessel_name, voyage_number
- bill_of_lading_number, booking_number
- origin_port_code, dest_port_code
- eta_origin, ata_origin, loading_date, discharge_date
- route_code, carrier_code, carrier_name, operator
- 以及其他基础字段...

---

### 步骤5: 启动应用

**启动主服务:**

```bash
cd backend
npm install
npm run build
npm run dev
```

**验证数据库连接:**

查看日志输出，确认:
```
✅ Database connected successfully
   host: localhost
   port: 5432
   database: logix_db
```

---

## 🔄 数据迁移

### 迁移现有数据库

**如果已存在旧版本数据库，执行迁移:**

```bash
psql -U postgres -d logix_db -f scripts/migrate-container-loading-records.sql
```

**迁移内容:**
- 添加 11 个新字段到 container_loading_records 表
- 重命名列以匹配实体类
- 添加字段注释

---

### TypeORM 迁移（推荐）

**生成迁移文件:**

```bash
cd backend
npm run migration:generate -- src/database/migrations/InitialSchema
```

**运行迁移:**

```bash
npm run migration:run
```

**回滚迁移:**

```bash
npm run migration:revert
```

---

## 🛠️ 故障排查

### 问题1: 连接数据库失败

**错误信息:**
```
Error: connect ECONNREFUSED 127.0.0.1:5432
```

**解决方案:**

1. 检查 PostgreSQL 服务是否运行:
   ```bash
   # Windows
   Get-Service postgresql-x64-14

   # Linux/macOS
   brew services list postgresql
   ```

2. 检查端口是否被占用:
   ```bash
   netstat -an | grep 5432
   ```

3. 检查防火墙设置

---

### 问题2: 表已存在错误

**错误信息:**
```
ERROR:  relation "dict_ports" already exists
```

**解决方案:**

使用 `IF NOT EXISTS` 子句（已在脚本中包含）或删除现有表:

```sql
DROP TABLE IF EXISTS container_loading_records CASCADE;
DROP TABLE IF EXISTS container_status_events CASCADE;
-- ... 逐个删除所有表
```

---

### 问题3: 外键约束失败

**错误信息:**
```
ERROR:  insert or update on table violates foreign key constraint
```

**解决方案:**

1. 确保引用的表已创建
2. 确保引用的记录存在
3. 检查外键列数据类型是否匹配

---

### 问题4: 实体字段不匹配

**症状:**
- TypeORM 同步失败
- 查询时字段不存在

**解决方案:**

1. 运行迁移脚本:
   ```bash
   psql -U postgres -d logix_db -f scripts/migrate-container-loading-records.sql
   ```

2. 检查实体类字段与表结构是否一致

3. 更新 TypeORM 配置:
   ```typescript
   synchronize: process.env.NODE_ENV === 'development'
   ```

---

## 📊 性能优化

### 索引优化

**创建复合索引:**

```sql
-- container_loading_records 复合索引
CREATE INDEX idx_clr_container_route
  ON container_loading_records(container_number, route_path);

CREATE INDEX idx_clr_voyage
  ON container_loading_records(vessel_name, voyage_number);

-- port_operations 复合索引
CREATE INDEX idx_po_container_port
  ON process_port_operations(container_number, port_code);
```

---

### 查询优化

**使用 EXPLAIN 分析查询:**

```sql
EXPLAIN ANALYZE
SELECT * FROM container_loading_records
WHERE container_number = 'CNTR1234567'
ORDER BY route_path;
```

---

## 🔒 安全建议

### 生产环境配置

1. **禁用自动同步:**
   ```env
   DB_SYNCHRONIZE=false
   ```

2. **使用强密码:**
   ```bash
   # 生成随机密码
   openssl rand -base64 32
   ```

3. **限制网络访问:**
   ```sql
   -- 只允许特定 IP 访问
   REVOKE CONNECT ON DATABASE logix_db FROM PUBLIC;
   GRANT CONNECT ON DATABASE logix_db TO app_user;
   ```

4. **定期备份:**
   ```bash
   pg_dump -U postgres logix_db > backup_$(date +%Y%m%d).sql
   ```

---

## 📝 维护任务

### 日常维护

**每日任务:**
- 检查数据库连接数
- 监控慢查询
- 备份事务日志

**每周任务:**
- 运行 VACUUM ANALYZE
- 检查表大小
- 清理过期数据

**每月任务:**
- 完整数据库备份
- 索引重建
- 性能分析

### 清理脚本

```bash
# VACUUM 优化
psql -U postgres -d logix_db -c "VACUUM ANALYZE;"

# 清理过期日志（保留30天）
psql -U postgres -d logix_db -c "DELETE FROM sys_audit_logs WHERE created_at < NOW() - INTERVAL '30 days';"
```

---

## 📚 相关文档

- [DATABASE_INITIALIZATION_CHECK.md](./DATABASE_INITIALIZATION_CHECK.md) - 数据库初始化检查报告
- [CODE_DB_CONSISTENCY_CHECK.md](./CODE_DB_CONSISTENCY_CHECK.md) - 代码与数据库一致性检查
- [README.md](../README.md) - 项目总览

---

## 🆘 支持

如遇问题，请提供以下信息:

1. 错误日志
2. PostgreSQL 版本: `SELECT version();`
3. 表结构: `\d table_name`
4. 配置文件内容（敏感信息已脱敏）

---

**文档维护**: Auto (AI Assistant)
**最后更新**: 2026-02-24
